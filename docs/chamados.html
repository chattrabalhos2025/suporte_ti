<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suporte T√©cnico ‚Äî Meus Chamados</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { scroll-behavior: smooth; }

    .animated-bg {
      background: radial-gradient(circle at top, rgba(56,189,248,0.18), transparent 55%),
                  radial-gradient(circle at bottom, rgba(129,140,248,0.2), transparent 55%),
                  #020617;
    }
  </style>
</head>
<body class="min-h-screen animated-bg text-slate-50">

  <!-- TOP NAV -->
  <header class="border-b border-white/10 bg-slate-950/70 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="relative">
          <img
            src="logo-helptech.png"
            alt="Logo HelpTech"
            class="h-8 w-auto rounded-xl shadow shadow-sky-500/40"
          />
          <span class="absolute -bottom-1 -right-1 h-3 w-3 rounded-full bg-emerald-400 border border-slate-900"></span>
        </div>
        <div class="flex flex-col leading-tight">
          <span class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
            Painel do Usu√°rio
          </span>
          <h1 class="text-lg font-semibold text-slate-50" id="tituloPagina">
            Meus Chamados
          </h1>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <!-- Bot√£o abrir novo chamado (apenas usu√°rio comum) -->
        <a href="dashboard.html"
           class="hidden sm:inline-flex items-center gap-2 rounded-2xl border border-white/10 px-3 py-2 text-xs font-medium text-slate-200 hover:bg-white/10 hover:-translate-y-[1px] transition"
           id="btnNovoChamado">
          ‚ûï Abrir novo chamado
        </a>

        <!-- Atalho mobile -->
        <a href="dashboard.html"
           id="btnNovoChamadoMobile"
           class="sm:hidden inline-flex items-center justify-center rounded-2xl border border-white/10 px-2.5 py-1.5 text-xs text-slate-100 hover:bg-white/10 transition">
          ‚ûï
        </a>

        <!-- Perfil -->
        <a id="btnProfileCircle"
           href="profile.html"
           class="w-9 h-9 rounded-full bg-slate-800 border border-white/15 text-xs font-semibold text-slate-50 flex items-center justify-center hover:bg-slate-700 hover:-translate-y-[1px] transition"
           title="Minha conta">
          ??
        </a>

        <!-- Logout -->
        <button id="logoutTop"
                class="hidden sm:inline-flex items-center gap-2 rounded-2xl bg-red-500/90 px-3 py-2 text-xs font-semibold text-white hover:bg-red-500 hover:-translate-y-[1px] shadow-sm transition">
          Sair
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto px-4 py-8 space-y-6">

    <!-- EMPTY STATE -->
    <section id="emptyState" class="hidden">
      <div class="bg-slate-950/70 border border-dashed border-white/20 rounded-3xl p-8 text-center shadow-2xl shadow-black/50 backdrop-blur">
        <div class="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-slate-900/80 border border-white/10 text-xl mb-3">
          üì≠
        </div>
        <h2 class="text-lg font-semibold text-slate-50">Nenhum chamado encontrado</h2>
        <p class="text-slate-300 text-sm mt-2 max-w-md mx-auto" id="emptyText">
          Assim que voc√™ abrir um chamado, ele aparecer√° aqui.
        </p>
        <a href="dashboard.html"
           id="linkAbrirChamadoEmpty"
           class="mt-5 inline-flex rounded-2xl border border-white/15 bg-white/5 px-4 py-2.5 text-sm font-medium text-slate-50 hover:bg-white/10 hover:-translate-y-[1px] transition">
          ‚ûï Abrir chamado
        </a>
      </div>
    </section>

    <!-- CARD PRINCIPAL: LISTA DE CHAMADOS -->
    <section id="tableWrap" class="bg-slate-950/75 border border-white/10 rounded-3xl shadow-2xl shadow-black/50 backdrop-blur overflow-hidden">
      <!-- Cabe√ßalho -->
      <div class="px-6 py-4 border-b border-white/10 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h2 class="text-base font-semibold text-slate-50 flex items-center gap-2" id="tituloListaChamados">
            Meus Chamados
          </h2>
          <p class="text-xs text-slate-300 mt-1" id="subTituloLista">
            Status dispon√≠veis: <span class="font-medium text-slate-100">Em aberto</span>, <span class="font-medium text-slate-100">Em andamento</span>, <span class="font-medium text-slate-100">Resolvido</span>.  
          </p>
        </div>

        <div class="flex items-center gap-2">
          <span id="totalChamadosBadge"
                class="inline-flex items-center gap-1 rounded-full bg-slate-900/80 border border-white/10 px-3 py-1 text-[11px] font-semibold text-slate-100">
            0 chamados
          </span>
          <button id="limpar"
                  class="inline-flex items-center gap-1 rounded-2xl border border-white/15 bg-white/5 px-3 py-2 text-xs font-medium text-slate-100 hover:bg-red-500/10 hover:border-red-400/40 hover:text-red-100 hover:-translate-y-[1px] transition">
            üßπ Limpar todos (local)
          </button>
        </div>
      </div>

      <!-- BARRA DE FILTROS (SOMENTE ADMIN) -->
      <div id="adminFilters" class="hidden px-6 py-3 border-b border-white/10 text-xs text-slate-200 bg-slate-950/90">
        <div class="flex flex-col lg:flex-row gap-3 lg:items-end lg:justify-between">
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 w-full lg:max-w-4xl">
            <!-- Status -->
            <div class="flex flex-col gap-1">
              <label for="filtroStatusAdmin" class="text-[11px] uppercase tracking-[0.16em] text-slate-400">
                Status
              </label>
              <select
                id="filtroStatusAdmin"
                class="w-full rounded-2xl border border-white/15 bg-slate-950/70 px-3 py-2 text-xs text-slate-50 focus:ring-1 focus:ring-sky-400 focus:border-sky-400 outline-none"
              >
                <option value="todos">Todos</option>
                <option value="Em aberto">Em aberto</option>
                <option value="Em andamento">Em andamento</option>
                <option value="Resolvido">Resolvido</option>
              </select>
            </div>

            <!-- Per√≠odo -->
            <div class="flex flex-col gap-1">
              <label for="filtroPeriodoAdmin" class="text-[11px] uppercase tracking-[0.16em] text-slate-400">
                Per√≠odo
              </label>
              <select
                id="filtroPeriodoAdmin"
                class="w-full rounded-2xl border border-white/15 bg-slate-950/70 px-3 py-2 text-xs text-slate-50 focus:ring-1 focus:ring-sky-400 focus:border-sky-400 outline-none"
              >
                <option value="todos">Todos os per√≠odos</option>
                <option value="hoje">Hoje</option>
                <option value="7">√öltimos 7 dias</option>
                <option value="30">√öltimos 30 dias</option>
              </select>
            </div>

            <!-- Data espec√≠fica -->
            <div class="flex flex-col gap-1">
              <label for="filtroDataAdmin" class="text-[11px] uppercase tracking-[0.16em] text-slate-400">
                Data espec√≠fica
              </label>
              <input
                type="date"
                id="filtroDataAdmin"
                class="w-full rounded-2xl border border-white/15 bg-slate-950/70 px-3 py-2 text-xs text-slate-50 focus:ring-1 focus:ring-sky-400 focus:border-sky-400 outline-none"
              />
              <span class="text-[10px] text-slate-500 mt-0.5">
                Se preencher a data, o per√≠odo √© ignorado.
              </span>
            </div>

            <!-- Busca por ID com lupa -->
            <div class="flex flex-col gap-1">
              <label for="filtroBuscaIdAdmin" class="text-[11px] uppercase tracking-[0.16em] text-slate-400">
                Buscar por ID
              </label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400 text-xs">
                  üîç
                </span>
                <input
                  type="text"
                  id="filtroBuscaIdAdmin"
                  placeholder="Ex: CH-0001"
                  class="w-full rounded-2xl border border-white/15 bg-slate-950/70 px-3 pl-7 py-2 text-xs text-slate-50 placeholder:text-slate-500 focus:ring-1 focus:ring-sky-400 focus:border-sky-400 outline-none"
                />
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <button
              id="btnLimparFiltros"
              class="inline-flex items-center justify-center rounded-2xl border border-white/15 bg-white/5 px-3 py-2 text-[11px] font-medium text-slate-100 hover:bg-white/10 hover:-translate-y-[1px] transition w-full sm:w-auto"
            >
              Limpar filtros
            </button>
            <button
              id="btnIrParaChamados"
              class="inline-flex items-center justify-center rounded-2xl border border-white/15 bg-white/5 px-3 py-2 text-[11px] font-medium text-slate-100 hover:bg-white/10 hover:-translate-y-[1px] transition w-full sm:w-auto"
            >
              üìã Atualizar listagem
            </button>
          </div>
        </div>
      </div>

      <!-- TABELA -->
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs md:text-sm">
          <thead class="bg-slate-950/80 border-b border-white/10">
            <tr class="text-left text-slate-200">
              <th class="px-6 py-3 font-medium">ID</th>
              <th class="px-6 py-3 font-medium">Categoria</th>
              <th class="px-6 py-3 font-medium">Descri√ß√£o</th>
              <th class="px-6 py-3 font-medium whitespace-nowrap">Criado em</th>
              <th class="px-6 py-3 font-medium">Status / Situa√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-white/5"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL DETALHES DO CHAMADO -->
  <div
    id="detalheModal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60 backdrop-blur-sm"
  >
    <div class="relative w-full max-w-lg mx-4">
      <div class="bg-slate-950/95 border border-white/10 rounded-3xl shadow-2xl shadow-black/60 p-6 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-base font-semibold text-slate-50 flex items-center gap-2">
              Detalhes do chamado
              <span id="detStatusBadge" class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold"></span>
            </h2>
            <p class="text-xs text-slate-300 mt-1">
              Visualize as informa√ß√µes completas do chamado selecionado.
            </p>
          </div>
          <button
            id="btnFecharDetalhe"
            class="inline-flex items-center justify-center rounded-xl border border-white/10 w-8 h-8 text-slate-200 hover:bg-white/10 transition text-sm"
          >
            ‚úï
          </button>
        </div>

        <div class="space-y-3 text-sm">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">ID do chamado</p>
              <p class="font-mono text-slate-50 text-xs sm:text-sm" id="detId">‚Äî</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Categoria</p>
              <p class="text-slate-50" id="detCategoria">‚Äî</p>
            </div>
          </div>

          <div>
            <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">E-mail do usu√°rio</p>
            <p class="text-slate-50 break-all text-xs sm:text-sm" id="detUsuarioEmail">‚Äî</p>
          </div>

          <div>
            <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400 mb-1">Descri√ß√£o completa</p>
            <div class="rounded-2xl border border-white/10 bg-slate-900/60 px-3 py-2.5 text-sm text-slate-100 max-h-52 overflow-auto whitespace-pre-wrap" id="detDescricao">
              ‚Äî
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Status</p>
              <p class="text-slate-50 text-sm" id="detStatusTexto">‚Äî</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Situa√ß√£o</p>
              <p class="text-slate-50 text-sm" id="detPrioridade">‚Äî</p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Criado em</p>
              <p class="text-slate-50 text-sm" id="detCriadoEm">‚Äî</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">√öltima altera√ß√£o de status</p>
              <p class="text-slate-50 text-xs sm:text-sm" id="detUltimaStatusPor">Por: ‚Äî</p>
              <p class="text-slate-50 text-xs sm:text-sm" id="detUltimaStatusEm">Em: ‚Äî</p>
            </div>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-2">
          <button
            id="btnFecharDetalhe2"
            class="inline-flex items-center justify-center rounded-2xl border border-white/10 px-4 py-2.5 text-sm font-medium text-slate-100 hover:bg-white/10 transition w-full sm:w-auto"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================== SESS√ÉO & PERFIL HEADER =====================
    function getSessionUser() {
      try {
        return JSON.parse(localStorage.getItem('sessionUser') || 'null');
      } catch {
        return null;
      }
    }

    function initials(nome) {
      return (nome || '')
        .split(' ')
        .filter(Boolean)
        .slice(0, 2)
        .map(s => s[0].toUpperCase())
        .join('') || '??';
    }

    const sess = getSessionUser();
    if (!sess) {
      window.location.href = 'index.html';
    }

    const isAdmin = sess?.perfil === 'admin';

    const btnProfileCircle      = document.getElementById('btnProfileCircle');
    const tituloPagina          = document.getElementById('tituloPagina');
    const tituloListaChamados   = document.getElementById('tituloListaChamados');
    const subTituloLista        = document.getElementById('subTituloLista');
    const btnNovoChamado        = document.getElementById('btnNovoChamado');
    const btnNovoChamadoMobile  = document.getElementById('btnNovoChamadoMobile');
    const emptyText             = document.getElementById('emptyText');
    const linkAbrirChamadoEmpty = document.getElementById('linkAbrirChamadoEmpty');
    const adminFilters          = document.getElementById('adminFilters');

    btnProfileCircle.textContent = initials(sess?.nome);

    if (isAdmin) {
      // Admin v√™ todos os chamados, filtros e n√£o pode abrir novo chamado
      tituloPagina.textContent        = 'Listagem de Chamados (Admin)';
      tituloListaChamados.textContent = 'Todos os Chamados';
      subTituloLista.textContent      = 'Somente administradores podem alterar o status e a situa√ß√£o dos chamados listados abaixo.';
      if (btnNovoChamado)       btnNovoChamado.classList.add('hidden');
      if (btnNovoChamadoMobile) btnNovoChamadoMobile.classList.add('hidden');
      emptyText.textContent = 'Ainda n√£o h√° chamados registrados. Assim que os usu√°rios abrirem chamados, eles aparecer√£o aqui.';
      linkAbrirChamadoEmpty.classList.add('hidden');

      adminFilters.classList.remove('hidden');
    } else {
      tituloPagina.textContent        = 'Meus Chamados';
      tituloListaChamados.textContent = 'Meus Chamados';
    }

    function doLogout() {
      localStorage.removeItem('sessionUser');
      window.location.href = 'index.html';
    }
    document.getElementById('logoutTop').addEventListener('click', doLogout);

    // ===================== CHAMADOS (LOCALSTORAGE) =====================
    function loadChamados() {
      try {
        return JSON.parse(localStorage.getItem('chamados') || '[]');
      } catch {
        return [];
      }
    }

    function saveChamados(lista) {
      localStorage.setItem('chamados', JSON.stringify(lista));
    }

    function formatDate(iso) {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleString('pt-BR');
    }

    function badgeClass(status) {
      switch (status) {
        case 'Em andamento':
          return 'bg-amber-100 text-amber-900 ring-1 ring-amber-300';
        case 'Resolvido':
          return 'bg-emerald-100 text-emerald-900 ring-1 ring-emerald-300';
        default:
          return 'bg-sky-100 text-sky-900 ring-1 ring-sky-300';
      }
    }

    function prioridadeClass(prioridade) {
      switch (prioridade) {
        case 'Baixa':
          return 'bg-emerald-100 text-emerald-900 ring-1 ring-emerald-300';
        case 'Alta':
          return 'bg-orange-100 text-orange-900 ring-1 ring-orange-300';
        case 'Cr√≠tica':
          return 'bg-red-100 text-red-900 ring-1 ring-red-300';
        case 'Aguardando triagem':
          return 'bg-slate-100 text-slate-900 ring-1 ring-slate-300';
        default: // M√©dia ou qualquer outro
          return 'bg-indigo-100 text-indigo-900 ring-1 ring-indigo-300';
      }
    }

    function updateTotalBadge(total) {
      const badge = document.getElementById('totalChamadosBadge');
      if (!badge) return;
      if (total === 0) {
        badge.textContent = '0 chamados';
        return;
      }
      badge.textContent = total === 1 ? '1 chamado' : `${total} chamados`;
    }

    // ====== Fun√ß√µes de filtro (admin) ======
    const filtroStatusAdmin   = document.getElementById('filtroStatusAdmin');
    const filtroPeriodoAdmin  = document.getElementById('filtroPeriodoAdmin');
    const filtroDataAdmin     = document.getElementById('filtroDataAdmin');
    const filtroBuscaIdAdmin  = document.getElementById('filtroBuscaIdAdmin');
    const btnLimparFiltros    = document.getElementById('btnLimparFiltros');
    const btnIrParaChamados   = document.getElementById('btnIrParaChamados');

    function normalizarDataLocal(dateObj) {
      const offsetMs = dateObj.getTimezoneOffset() * 60000;
      const local = new Date(dateObj.getTime() - offsetMs);
      return local.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    function aplicarFiltrosAdmin(lista) {
      let filtrada = lista.slice();

      if (!isAdmin) return filtrada;

      const status   = filtroStatusAdmin?.value || 'todos';
      const periodo  = filtroPeriodoAdmin?.value || 'todos';
      const dataStr  = filtroDataAdmin?.value || '';
      const buscaId  = (filtroBuscaIdAdmin?.value || '').trim().toLowerCase();

      // Filtro por ID (lupa)
      if (buscaId) {
        filtrada = filtrada.filter(c =>
          String(c.id || '').toLowerCase().includes(buscaId)
        );
      }

      // Filtro por status
      if (status !== 'todos') {
        filtrada = filtrada.filter(c => (c.status || 'Em aberto') === status);
      }

      // Se houver data espec√≠fica, ignora "per√≠odo"
      if (dataStr) {
        filtrada = filtrada.filter(c => {
          const d = new Date(c.criadoEm);
          if (Number.isNaN(d.getTime())) return false;
          return normalizarDataLocal(d) === dataStr;
        });
        return filtrada;
      }

      // Filtro por per√≠odo relativo
      if (periodo !== 'todos') {
        const hoje = new Date();
        let dias = 0;

        if (periodo === 'hoje') {
          dias = 1;
        } else {
          dias = parseInt(periodo, 10) || 0;
        }

        if (dias > 0) {
          const limiteMs = hoje.getTime() - dias * 24 * 60 * 60 * 1000;
          filtrada = filtrada.filter(c => {
            const d = new Date(c.criadoEm);
            if (Number.isNaN(d.getTime())) return false;
            return d.getTime() >= limiteMs;
          });
        }
      }

      return filtrada;
    }

    // ===================== MODAL DETALHES =====================
    const detalheModal      = document.getElementById('detalheModal');
    const btnFecharDetalhe  = document.getElementById('btnFecharDetalhe');
    const btnFecharDetalhe2 = document.getElementById('btnFecharDetalhe2');
    const detId             = document.getElementById('detId');
    const detCategoria      = document.getElementById('detCategoria');
    const detDescricao      = document.getElementById('detDescricao');
    const detStatusTexto    = document.getElementById('detStatusTexto');
    const detStatusBadge    = document.getElementById('detStatusBadge');
    const detCriadoEm       = document.getElementById('detCriadoEm');
    const detUsuarioEmail   = document.getElementById('detUsuarioEmail');
    const detPrioridade     = document.getElementById('detPrioridade');
    const detUltimaStatusPor= document.getElementById('detUltimaStatusPor');
    const detUltimaStatusEm = document.getElementById('detUltimaStatusEm');

    function abrirModalDetalhe(chamado) {
      const prioridade = chamado.prioridade || 'Aguardando triagem';

      detId.textContent           = chamado.id || '‚Äî';
      detCategoria.textContent    = chamado.categoria || '‚Äî';
      detDescricao.textContent    = chamado.descricao || '‚Äî';
      detStatusTexto.textContent  = chamado.status || 'Em aberto';
      detCriadoEm.textContent     = formatDate(chamado.criadoEm);
      detUsuarioEmail.textContent = chamado.usuarioEmail || '‚Äî';
      detPrioridade.textContent   = prioridade;

      detStatusBadge.className =
        'inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold ' +
        badgeClass(chamado.status || 'Em aberto');
      detStatusBadge.textContent = chamado.status || 'Em aberto';

      const por = chamado.ultimaAlteracaoStatusPor || '‚Äî';
      const em  = chamado.ultimaAlteracaoStatusEm
        ? formatDate(chamado.ultimaAlteracaoStatusEm)
        : '‚Äî';

      detUltimaStatusPor.textContent = 'Por: ' + por;
      detUltimaStatusEm.textContent  = 'Em: ' + em;

      detalheModal.classList.remove('hidden');
      detalheModal.classList.add('flex');
    }

    function fecharModalDetalhe() {
      detalheModal.classList.add('hidden');
      detalheModal.classList.remove('flex');
    }

    btnFecharDetalhe.addEventListener('click', fecharModalDetalhe);
    btnFecharDetalhe2.addEventListener('click', fecharModalDetalhe);

    // Fechar clicando no fundo
    detalheModal.addEventListener('click', (e) => {
      if (e.target === detalheModal) {
        fecharModalDetalhe();
      }
    });

    // Fechar com ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !detalheModal.classList.contains('hidden')) {
        fecharModalDetalhe();
      }
    });

    // ===================== RENDER TABELA =====================
    function render() {
      const tbody     = document.getElementById('tbody');
      const empty     = document.getElementById('emptyState');
      const tableWrap = document.getElementById('tableWrap');

      const todosChamados = loadChamados();
      let lista;

      if (isAdmin) {
        lista = todosChamados.slice();
        lista = aplicarFiltrosAdmin(lista);
      } else {
        lista = todosChamados.filter(c =>
          (c.usuarioEmail || '').toLowerCase() === (sess.email || '').toLowerCase()
        );
      }

      // Ordena por data desc
      lista.sort((a, b) => {
        const da = new Date(a.criadoEm);
        const db = new Date(b.criadoEm);
        return db - da;
      });

      updateTotalBadge(lista.length);

      if (!lista.length) {
        empty.classList.remove('hidden');
        tableWrap.classList.add('hidden');
        tbody.innerHTML = '';
        return;
      }

      empty.classList.add('hidden');
      tableWrap.classList.remove('hidden');

      tbody.innerHTML = '';

      lista.forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.className = idx % 2 === 0 ? 'bg-slate-950/60' : 'bg-slate-950/40';

        const prioridade = c.prioridade || 'Aguardando triagem';

        const tdId = document.createElement('td');
        tdId.className = 'px-6 py-3 font-mono text-[11px] text-slate-200 align-top';
        tdId.textContent = c.id;

        const tdCat = document.createElement('td');
        tdCat.className = 'px-6 py-3 text-slate-50 align-top';
        tdCat.textContent = c.categoria || '‚Äî';

        const tdDesc = document.createElement('td');
        tdDesc.className = 'px-6 py-3 max-w-[22rem] text-slate-100 align-top';
        tdDesc.innerHTML = `<p class="line-clamp-3 text-xs md:text-sm text-slate-100/90">${c.descricao || '‚Äî'}</p>`;

        const tdCriado = document.createElement('td');
        tdCriado.className = 'px-6 py-3 whitespace-nowrap text-slate-200 align-top';
        tdCriado.textContent = formatDate(c.criadoEm);

        const tdStatus = document.createElement('td');
        tdStatus.className = 'px-6 py-3 align-top';

        const wrap = document.createElement('div');
        wrap.className = 'flex flex-col gap-2';

        const linhaStatus = document.createElement('div');
        linhaStatus.className = 'flex flex-col sm:flex-row sm:items-center gap-2';

        const badge = document.createElement('span');
        badge.className =
          'inline-flex items-center px-2.5 py-1 rounded-full text-[11px] font-semibold ' +
          badgeClass(c.status);
        badge.textContent = c.status || 'Em aberto';
        linhaStatus.appendChild(badge);

        // Badge de situa√ß√£o (baseado na prioridade)
        const badgePri = document.createElement('span');
        badgePri.className =
          'inline-flex items-center px-2.5 py-1 rounded-full text-[11px] font-semibold ' +
          prioridadeClass(prioridade);
        badgePri.textContent = 'Situa√ß√£o: ' + prioridade;
        linhaStatus.appendChild(badgePri);

        // ======= S√ì ADMIN pode mudar o status e a situa√ß√£o (prioridade) =======
        if (isAdmin) {
          const selectStatus = document.createElement('select');
          selectStatus.className =
            'rounded-xl border border-white/15 bg-slate-950/70 px-2 py-1 text-[11px] text-slate-50 focus:ring-1 focus:ring-sky-400 focus:border-sky-400 outline-none';

          ['Em aberto', 'Em andamento', 'Resolvido'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            if (opt === (c.status || 'Em aberto')) o.selected = true;
            selectStatus.appendChild(o);
          });

          selectStatus.addEventListener('change', e => {
            const listaAtual = loadChamados();
            const i = listaAtual.findIndex(x => x.id === c.id);
            if (i >= 0) {
              listaAtual[i].status = e.target.value;
              listaAtual[i].ultimaAlteracaoStatusPor = sess.email || sess.nome || 'admin';
              listaAtual[i].ultimaAlteracaoStatusEm  = new Date().toISOString();
              saveChamados(listaAtual);
              render(); // re-render para atualizar com filtros
            }
          });

          // Select de situa√ß√£o (prioridade)
          const selectPri = document.createElement('select');
          selectPri.className =
            'rounded-xl border border-white/15 bg-slate-950/70 px-2 py-1 text-[11px] text-slate-50 focus:ring-1 focus:ring-sky-400 focus:border-sky-400 outline-none';

          ['Aguardando triagem', 'Baixa', 'M√©dia', 'Alta', 'Cr√≠tica'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            if (opt === prioridade) o.selected = true;
            selectPri.appendChild(o);
          });

          selectPri.addEventListener('change', e => {
            const listaAtual = loadChamados();
            const i = listaAtual.findIndex(x => x.id === c.id);
            if (i >= 0) {
              listaAtual[i].prioridade = e.target.value;
              saveChamados(listaAtual);
              render();
            }
          });

          const linhaEdicao = document.createElement('div');
          linhaEdicao.className = 'flex flex-wrap gap-2';
          linhaEdicao.appendChild(selectStatus);
          linhaEdicao.appendChild(selectPri);

          wrap.appendChild(linhaStatus);
          wrap.appendChild(linhaEdicao);
        } else {
          // Usu√°rio comum: s√≥ v√™ os badges (status + situa√ß√£o), sem selects
          wrap.appendChild(linhaStatus);
        }
        // ============================================

        // Bot√£o "Ver detalhes"
        const btnDetalhes = document.createElement('button');
        btnDetalhes.textContent = 'Ver detalhes';
        btnDetalhes.className =
          'inline-flex items-center justify-center rounded-xl border border-white/15 bg-white/5 px-3 py-1.5 text-[11px] font-medium text-slate-100 hover:bg-white/10 hover:-translate-y-[1px] transition self-start';
        btnDetalhes.addEventListener('click', () => abrirModalDetalhe(c));

        wrap.appendChild(btnDetalhes);

        tdStatus.appendChild(wrap);

        tr.appendChild(tdId);
        tr.appendChild(tdCat);
        tr.appendChild(tdDesc);
        tr.appendChild(tdCriado);
        tr.appendChild(tdStatus);

        tbody.appendChild(tr);
      });
    }

    // Bot√£o limpar com comportamento diferente para admin x usu√°rio
    const btnLimpar = document.getElementById('limpar');

    if (!isAdmin) {
      btnLimpar.textContent = 'üßπ Limpar meus chamados (local)';
    }

    btnLimpar.addEventListener('click', () => {
      const msg = isAdmin
        ? 'Tem certeza que deseja limpar TODOS os chamados salvos localmente?'
        : 'Tem certeza que deseja limpar APENAS os seus chamados?';

      if (!confirm(msg)) return;

      const todos = loadChamados();

      if (isAdmin) {
        localStorage.removeItem('chamados');
      } else {
        const restantes = todos.filter(c =>
          (c.usuarioEmail || '').toLowerCase() !== (sess.email || '').toLowerCase()
        );
        saveChamados(restantes);
      }

      render();
    });

    // ===== Eventos de filtro (admin) =====
    if (isAdmin) {
      filtroStatusAdmin.addEventListener('change', render);
      filtroPeriodoAdmin.addEventListener('change', render);
      filtroDataAdmin.addEventListener('change', render);
      filtroBuscaIdAdmin.addEventListener('input', render);

      btnLimparFiltros.addEventListener('click', () => {
        filtroStatusAdmin.value  = 'todos';
        filtroPeriodoAdmin.value = 'todos';
        filtroDataAdmin.value    = '';
        filtroBuscaIdAdmin.value = '';
        render();
      });

      btnIrParaChamados.addEventListener('click', () => {
        render();
        document.getElementById('tableWrap').scrollIntoView({ behavior: 'smooth' });
      });
    }

    // Render inicial
    render();
  </script>
</body>
</html>
