<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suporte T√©cnico ‚Äî Novo Chamado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { scroll-behavior: smooth; }

    /* Fundo com leve anima√ß√£o de gradiente */
    .animated-bg {
      background: radial-gradient(circle at top, rgba(56,189,248,0.18), transparent 55%),
                  radial-gradient(circle at bottom, rgba(129,140,248,0.2), transparent 55%),
                  #020617;
    }
  </style>
</head>
<body class="min-h-screen animated-bg text-slate-50">

  <!-- TOP NAV -->
  <header class="border-b border-white/10 bg-slate-950/70 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="relative">
          <img
            src="logo-helptech.png"
            alt="Logo HelpTech"
            class="h-8 w-auto rounded-xl shadow shadow-sky-500/40"
          />
          <span class="absolute -bottom-1 -right-1 h-3 w-3 rounded-full bg-emerald-400 border border-slate-900"></span>
        </div>
        <div class="flex flex-col leading-tight">
          <span class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
            Painel do Usu√°rio
          </span>
          <h1 class="text-lg font-semibold text-slate-50 flex items-center gap-2">
            Abrir novo chamado
            <span class="inline-flex items-center rounded-full bg-emerald-500/10 border border-emerald-400/40 px-2 py-[2px] text-[10px] font-semibold text-emerald-200">
              Online
            </span>
          </h1>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a href="chamados.html"
           class="hidden sm:inline-flex items-center gap-2 rounded-2xl border border-white/10 px-3 py-2 text-xs font-medium text-slate-200 hover:bg-white/10 hover:-translate-y-[1px] transition">
          üìã Meus chamados
        </a>

        <a href="chamados.html"
           class="sm:hidden inline-flex items-center justify-center rounded-2xl border border-white/10 px-2.5 py-1.5 text-xs text-slate-100 hover:bg-white/10 transition">
          üìã
        </a>

        <!-- Perfil -->
        <a id="btnProfileCircle"
           href="profile.html"
           class="w-9 h-9 rounded-full bg-slate-800 border border-white/15 text-xs font-semibold text-slate-50 flex items-center justify-center hover:bg-slate-700 hover:-translate-y-[1px] transition"
           title="Minha conta">
          ??
        </a>

        <!-- Logout -->
        <button id="logoutTop"
                class="hidden sm:inline-flex items-center gap-2 rounded-2xl bg-red-500/90 px-3 py-2 text-xs font-semibold text-white hover:bg-red-500 hover:-translate-y-[1px] shadow-sm transition">
          Sair
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-[minmax(0,1.2fr)_minmax(0,0.95fr)] gap-6 items-start">

      <!-- FORMUL√ÅRIO NOVO CHAMADO -->
      <section
        class="bg-slate-950/70 border border-white/10 rounded-3xl shadow-2xl shadow-black/50 backdrop-blur p-6 space-y-6 relative overflow-hidden"
      >
        <!-- glow decorativo -->
        <div class="pointer-events-none absolute -top-20 -right-24 h-56 w-56 rounded-full bg-sky-500/20 blur-3xl"></div>

        <!-- Cabe√ßalho do card -->
        <div class="relative flex flex-col gap-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold text-slate-50 flex items-center gap-2">
                Detalhes do chamado
                <span class="inline-flex items-center rounded-full bg-indigo-500/20 border border-indigo-400/40 px-2 py-[2px] text-[10px] font-semibold text-indigo-100">
                  Passo 1 de 2
                </span>
              </h2>
              <p class="text-sm text-slate-300 mt-1">
                Preencha as informa√ß√µes abaixo para que o suporte consiga entender rapidamente sua solicita√ß√£o.
              </p>
            </div>

            <!-- Barra de progresso -->
            <div class="hidden sm:flex flex-col items-end gap-1">
              <span class="text-[11px] text-slate-400" id="progressLabel">0% preenchido</span>
              <div class="w-32 h-1.5 rounded-full bg-slate-800 overflow-hidden">
                <div
                  id="progressBar"
                  class="h-full rounded-full bg-gradient-to-r from-sky-400 to-indigo-400 transition-all duration-300"
                  style="width: 0%;"
                ></div>
              </div>
            </div>
          </div>

          <!-- Etapas em linha -->
          <div class="flex items-center gap-3 text-[11px] text-slate-400 mt-1">
            <div class="flex items-center gap-2">
              <span class="flex h-5 w-5 items-center justify-center rounded-full bg-sky-500/20 border border-sky-400/60 text-[11px] text-sky-100">1</span>
              <span>Preencher dados</span>
            </div>
            <span class="h-px w-6 bg-slate-600"></span>
            <div class="flex items-center gap-2">
              <span class="flex h-5 w-5 items-center justify-center rounded-full bg-slate-800 border border-slate-600 text-[11px] text-slate-400">2</span>
              <span>Revisar e enviar</span>
            </div>
          </div>
        </div>

        <form id="formChamado" class="space-y-5 text-sm relative">

          <!-- Categoria -->
          <div class="space-y-1.5">
            <label for="categoria" class="block text-[11px] font-semibold tracking-[0.16em] uppercase text-slate-300">
              Categoria do problema
            </label>
            <select
              id="categoria"
              required
              class="w-full rounded-2xl border border-white/15 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-50 placeholder:text-slate-500 focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition"
            >
              <option value="">Selecione uma categoria</option>
              <option>Problema de acesso</option>
              <option>Erro no sistema</option>
              <option>Lentid√£o</option>
              <option>D√∫vida funcional</option>
              <option>Solicita√ß√£o de melhoria</option>
              <option>Outro</option>
            </select>
            <p class="text-[11px] text-slate-400">
              Exemplo: n√£o consegue logar, erro ao abrir tela, falha em relat√≥rio, etc.
            </p>
          </div>

          <!-- T√≠tulo (opcional) -->
          <div class="space-y-1.5">
            <div class="flex items-center justify-between gap-2">
              <label for="titulo" class="block text-[11px] font-semibold tracking-[0.16em] uppercase text-slate-300">
                T√≠tulo (opcional)
              </label>
              <span class="text-[11px] text-slate-500">
                M√°x. 120 caracteres
              </span>
            </div>
            <input
              id="titulo"
              type="text"
              maxlength="120"
              class="w-full rounded-2xl border border-white/15 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-50 placeholder:text-slate-500 focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition"
              placeholder="Ex: Erro ao acessar o sistema de chamados da ag√™ncia"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="space-y-1.5">
            <div class="flex items-center justify-between gap-2">
              <label for="descricao" class="block text-[11px] font-semibold tracking-[0.16em] uppercase text-slate-300">
                Descri√ß√£o detalhada
              </label>
              <span id="descricaoCount" class="text-[11px] text-slate-500">
                0 / 2000
              </span>
            </div>
            <textarea
              id="descricao"
              required
              rows="5"
              maxlength="2000"
              class="w-full rounded-2xl border border-white/15 bg-slate-900/70 px-3 py-2.5 text-sm text-slate-50 placeholder:text-slate-500 focus:ring-2 focus:ring-sky-400 focus:border-transparent outline-none transition resize-none"
              placeholder="Descreva o passo a passo do problema, mensagens de erro, hor√°rio aproximado, impacto no atendimento e qualquer outro detalhe importante."
            ></textarea>
            <p class="text-[11px] text-slate-400">
              Dica: informe se o problema impede o atendimento ao cliente ou se h√° alternativa tempor√°ria.
            </p>
          </div>

          <!-- Mensagem -->
          <p id="formMsg" class="text-xs mt-1"></p>

          <!-- A√á√ïES -->
          <div class="flex flex-col sm:flex-row gap-3 pt-3">
            <button
              type="submit"
              id="btnSubmitChamado"
              class="inline-flex justify-center items-center gap-2 rounded-2xl bg-gradient-to-r from-sky-500 to-indigo-500 px-4 py-2.5 text-sm font-semibold text-white hover:from-sky-400 hover:to-indigo-400 hover:-translate-y-[1px] shadow shadow-sky-500/40 transition disabled:opacity-60 disabled:cursor-not-allowed"
            >
              üöÄ Enviar chamado
            </button>

            <button
              type="button"
              id="btnLimparCampos"
              class="inline-flex justify-center items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-medium text-slate-100 hover:bg-white/10 hover:-translate-y-[1px] transition"
            >
              üßπ Limpar campos
            </button>
          </div>

          <div class="flex items-center justify-between gap-2 pt-1 text-[11px] text-slate-400">
            <span>
              Situa√ß√£o inicial do chamado: <span class="font-semibold text-slate-100">Aguardando triagem do suporte</span>.
            </span>
            <a href="chamados.html" class="hidden sm:inline text-sky-300 hover:text-sky-200 hover:underline">
              Ver minha fila de chamados ‚Üí
            </a>
          </div>
        </form>
      </section>

      <!-- LATERAL: PR√â-VISUALIZA√á√ÉO & DICAS -->
      <aside class="space-y-4">

        <!-- Card de pr√©-visualiza√ß√£o -->
        <section class="bg-slate-950/70 border border-sky-500/30 rounded-3xl shadow-xl shadow-black/50 backdrop-blur p-5 space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-sky-100 flex items-center gap-2">
              Pr√©-visualiza√ß√£o do chamado
              <span class="inline-flex items-center justify-center h-5 px-2 rounded-full bg-sky-500/15 border border-sky-400/40 text-[10px] font-semibold text-sky-100">
                Em rascunho
              </span>
            </h2>
          </div>

          <div class="rounded-2xl border border-white/5 bg-slate-900/70 px-3 py-3 space-y-2">
            <div class="flex items-center justify-between gap-2 text-[11px] text-slate-400">
              <span id="previewCategoria">Categoria: ‚Äî</span>
              <span class="inline-flex items-center gap-1 text-[11px]">
                Situa√ß√£o:
                <span class="inline-flex items-center rounded-full bg-slate-100/90 text-slate-900 px-2 py-[1px] font-semibold">
                  Aguardando triagem
                </span>
              </span>
            </div>
            <h3 id="previewTitulo" class="text-sm font-semibold text-slate-50">
              T√≠tulo do chamado aparecer√° aqui
            </h3>
            <p id="previewDescricao" class="text-xs text-slate-200 line-clamp-4">
              A descri√ß√£o resumida do chamado ser√° exibida aqui conforme voc√™ digita, ajudando a visualizar como o suporte enxergar√° sua solicita√ß√£o.
            </p>
          </div>

          <p class="text-[11px] text-slate-400">
            Ap√≥s enviar, o chamado aparecer√° em <span class="font-semibold text-slate-100">‚ÄúMeus Chamados‚Äù</span> com status
            <span class="font-semibold text-slate-100">Em aberto</span> e aguardando an√°lise do suporte.
          </p>
        </section>

        <!-- Card de boas pr√°ticas -->
        <section class="bg-slate-950/70 border border-white/10 rounded-3xl shadow-xl shadow-black/50 backdrop-blur p-5 space-y-3">
          <h2 class="text-sm font-semibold text-slate-50 flex items-center gap-2">
            Como abrir um bom chamado?
          </h2>
          <ul class="text-xs text-slate-200 space-y-1.5 list-disc list-inside">
            <li>Informe o sistema, ag√™ncia ou ambiente impactado.</li>
            <li>Descreva o que voc√™ fez antes do erro aparecer.</li>
            <li>Cole mensagens de erro ou c√≥digos que aparecerem na tela.</li>
            <li>Diga se outras pessoas tamb√©m est√£o com o mesmo problema.</li>
            <li>Indique se o problema impede o atendimento ao cliente.</li>
          </ul>
        </section>
      </aside>
    </div>
  </main>

  <script>
    // ===== SESS√ÉO / PERFIL =====
    function getSessionUser() {
      try {
        return JSON.parse(localStorage.getItem('sessionUser') || 'null');
      } catch {
        return null;
      }
    }

    function initials(nome) {
      return (nome || '')
        .split(' ')
        .filter(Boolean)
        .slice(0, 2)
        .map(s => s[0].toUpperCase())
        .join('') || '??';
    }

    const sess = getSessionUser();
    if (!sess) {
      window.location.href = 'index.html';
    } else if (sess.perfil === 'admin') {
      // Admin n√£o abre chamado ‚Üí vai direto para o dashboard admin
      window.location.href = 'admin.html';
    }

    const btnProfileCircle = document.getElementById('btnProfileCircle');
    btnProfileCircle.textContent = initials(sess?.nome);

    function doLogout() {
      localStorage.removeItem('sessionUser');
      window.location.href = 'index.html';
    }
    document.getElementById('logoutTop').addEventListener('click', doLogout);

    // ===== CHAMADOS (LOCALSTORAGE) =====
    function loadChamados() {
      try {
        return JSON.parse(localStorage.getItem('chamados') || '[]');
      } catch {
        return [];
      }
    }

    function saveChamados(lista) {
      localStorage.setItem('chamados', JSON.stringify(lista));
    }

    function setFormMsg(text, type) {
      const el = document.getElementById('formMsg');
      el.textContent = text || '';
      el.className = 'text-xs mt-1';
      if (type === 'error') el.classList.add('text-red-400');
      if (type === 'success') el.classList.add('text-emerald-400');
      if (type === 'info') el.classList.add('text-slate-300');
    }

    function gerarIdChamado(lista) {
      const prefix = 'CH-';
      const maxSeq = lista
        .map(c => c.id)
        .filter(id => typeof id === 'string' && id.startsWith(prefix))
        .map(id => parseInt(id.replace(prefix, ''), 10))
        .filter(n => !Number.isNaN(n))
        .reduce((max, n) => Math.max(max, n), 0);

      const next = maxSeq + 1;
      return prefix + String(next).padStart(4, '0');
    }

    // ===== FORM NOVO CHAMADO =====
    const formChamado      = document.getElementById('formChamado');
    const btnSubmitChamado = document.getElementById('btnSubmitChamado');
    const btnLimparCampos  = document.getElementById('btnLimparCampos');
    const campoCategoria   = document.getElementById('categoria');
    const campoTitulo      = document.getElementById('titulo');
    const campoDescricao   = document.getElementById('descricao');
    const descricaoCount   = document.getElementById('descricaoCount');

    // Preview
    const previewCategoria = document.getElementById('previewCategoria');
    const previewTitulo    = document.getElementById('previewTitulo');
    const previewDescricao = document.getElementById('previewDescricao');

    // Progresso
    const progressBar   = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');

    function atualizarPreview() {
      const cat = campoCategoria.value || '‚Äî';
      const tit = campoTitulo.value.trim() ||
        'T√≠tulo do chamado aparecer√° aqui';
      const desc = campoDescricao.value.trim() ||
        'A descri√ß√£o resumida do chamado ser√° exibida aqui conforme voc√™ digita, ajudando a visualizar como o suporte enxergar√° sua solicita√ß√£o.';

      previewCategoria.textContent = 'Categoria: ' + cat;
      previewTitulo.textContent = tit;
      previewDescricao.textContent = desc;
    }

    function atualizarContadorDescricao() {
      const atual = campoDescricao.value.length;
      descricaoCount.textContent = `${atual} / 2000`;
    }

    function calcularProgresso() {
      let pontos = 0;
      if (campoCategoria.value) pontos += 1;
      if (campoDescricao.value.trim().length > 10) pontos += 1;
      if (campoTitulo.value.trim().length > 0) pontos += 1;

      // 3 "steps" simples -> 0, 33, 66, 100
      const porcentagem = [0, 33, 66, 100][pontos];
      progressBar.style.width = porcentagem + '%';
      progressLabel.textContent = `${porcentagem}% preenchido`;
    }

    campoCategoria.addEventListener('change', () => {
      atualizarPreview();
      calcularProgresso();
    });

    campoTitulo.addEventListener('input', () => {
      atualizarPreview();
      calcularProgresso();
    });

    campoDescricao.addEventListener('input', () => {
      atualizarPreview();
      atualizarContadorDescricao();
      calcularProgresso();
    });

    btnLimparCampos.addEventListener('click', () => {
      campoCategoria.value = '';
      campoTitulo.value = '';
      campoDescricao.value = '';
      atualizarPreview();
      atualizarContadorDescricao();
      calcularProgresso();
      setFormMsg('', null);
    });

    formChamado.addEventListener('submit', (e) => {
      e.preventDefault();
      setFormMsg('', null);

      const categoria = campoCategoria.value.trim();
      const titulo    = campoTitulo.value.trim();
      const descricao = campoDescricao.value.trim();

      if (!categoria || !descricao) {
        setFormMsg('Preencha categoria e descri√ß√£o para continuar.', 'error');
        return;
      }

      // Situa√ß√£o / prioridade definida apenas pelo administrador
      const prioridade = 'Aguardando triagem';

      btnSubmitChamado.disabled = true;

      const lista = loadChamados();
      const id    = gerarIdChamado(lista);
      const agora = new Date().toISOString();

      const novoChamado = {
        id,
        categoria,
        prioridade,
        titulo,
        descricao,
        criadoEm: agora,
        status: 'Em aberto',
        usuarioEmail: sess?.email || null,
        usuarioNome: sess?.nome || null,
        usuarioPerfil: sess?.perfil || 'usuario'
      };

      lista.push(novoChamado);
      saveChamados(lista);

      setFormMsg('Chamado criado com sucesso! Redirecionando para Meus Chamados...', 'success');
      formChamado.reset();
      atualizarPreview();
      atualizarContadorDescricao();
      calcularProgresso();

      setTimeout(() => {
        window.location.href = 'chamados.html';
      }, 800);
    });

    // Inicializar estado visual
    atualizarPreview();
    atualizarContadorDescricao();
    calcularProgresso();
  </script>
</body>
</html>
