<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suporte T√©cnico ‚Äî Novo Chamado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { scroll-behavior: smooth; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-50">

  <!-- TOP NAV -->
  <header class="border-b border-white/10 bg-slate-900/60 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img
          src="logo-helptech.png"
          alt="Logo HelpTech"
          class="h-8 w-auto rounded-xl shadow"
        />
        <div class="flex flex-col leading-tight">
          <span class="text-xs uppercase tracking-[0.18em] text-slate-400">
            Painel do Usu√°rio
          </span>
          <h1 class="text-lg font-semibold text-slate-50">
            Abrir novo chamado
          </h1>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a href="chamados.html"
           class="hidden sm:inline-flex items-center gap-2 rounded-xl border border-white/10 px-3 py-2 text-xs font-medium text-slate-200 hover:bg-white/10 transition">
          üìã Meus chamados
        </a>

        <a href="chamados.html"
           class="sm:hidden inline-flex items-center justify-center rounded-xl border border-white/10 px-2.5 py-1.5 text-xs text-slate-100 hover:bg-white/10 transition">
          üìã
        </a>

        <!-- Perfil -->
        <a id="btnProfileCircle"
           href="profile.html"
           class="w-9 h-9 rounded-full bg-slate-800 border border-white/15 text-xs font-semibold text-slate-50 flex items-center justify-center hover:bg-slate-700 transition"
           title="Minha conta">
          ??
        </a>

        <!-- Logout -->
        <button id="logoutTop"
                class="hidden sm:inline-flex items-center gap-2 rounded-xl bg-red-500/90 px-3 py-2 text-xs font-semibold text-white hover:bg-red-500 shadow-sm transition">
          Sair
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-[minmax(0,1.2fr)_minmax(0,0.9fr)] gap-6">

      <!-- FORMUL√ÅRIO NOVO CHAMADO -->
      <section class="bg-white/5 border border-white/10 rounded-3xl shadow-xl shadow-black/40 backdrop-blur p-6 space-y-5">
        <div>
          <h2 class="text-base font-semibold text-slate-50 flex items-center gap-2">
            Detalhes do chamado
            <span class="inline-flex items-center rounded-full bg-indigo-500/15 border border-indigo-400/40 px-2 py-[2px] text-[10px] font-semibold text-indigo-200">
              Obrigat√≥rio
            </span>
          </h2>
          <p class="text-sm text-slate-300 mt-1">
            Quanto mais detalhes voc√™ fornecer, mais f√°cil ser√° para o suporte entender e resolver seu problema.
          </p>
        </div>

        <form id="formChamado" class="space-y-4 text-sm">
          <!-- Categoria -->
          <div>
            <label for="categoria" class="block text-xs font-semibold tracking-[0.16em] uppercase mb-1 text-slate-300">
              Categoria
            </label>
            <select
              id="categoria"
              required
              class="w-full rounded-2xl border border-white/15 bg-slate-900/60 px-3 py-2.5 text-sm text-slate-50 placeholder:text-slate-500 focus:ring-2 focus:ring-indigo-400 focus:border-transparent outline-none"
            >
              <option value="">Selecione uma categoria</option>
              <option>Problema de acesso</option>
              <option>Erro no sistema</option>
              <option>Lentid√£o</option>
              <option>D√∫vida funcional</option>
              <option>Solicita√ß√£o de melhoria</option>
              <option>Outro</option>
            </select>
          </div>

          <!-- Prioridade + T√≠tulo -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="prioridade" class="block text-xs font-semibold tracking-[0.16em] uppercase mb-1 text-slate-300">
                Prioridade
              </label>
              <select
                id="prioridade"
                required
                class="w-full rounded-2xl border border-white/15 bg-slate-900/60 px-3 py-2.5 text-sm text-slate-50 focus:ring-2 focus:ring-indigo-400 focus:border-transparent outline-none"
              >
                <option value="">Selecione a prioridade</option>
                <option>Baixa</option>
                <option>M√©dia</option>
                <option>Alta</option>
                <option>Cr√≠tica</option>
              </select>
            </div>

            <div>
              <label for="titulo" class="block text-xs font-semibold tracking-[0.16em] uppercase mb-1 text-slate-300">
                T√≠tulo (opcional)
              </label>
              <input
                id="titulo"
                type="text"
                maxlength="120"
                class="w-full rounded-2xl border border-white/15 bg-slate-900/60 px-3 py-2.5 text-sm text-slate-50 placeholder:text-slate-500 focus:ring-2 focus:ring-indigo-400 focus:border-transparent outline-none"
                placeholder="Ex: N√£o consigo acessar o sistema da ag√™ncia"
              />
            </div>
          </div>

          <!-- Descri√ß√£o -->
          <div>
            <label for="descricao" class="block text-xs font-semibold tracking-[0.16em] uppercase mb-1 text-slate-300">
              Descri√ß√£o detalhada
            </label>
            <textarea
              id="descricao"
              required
              rows="5"
              maxlength="2000"
              class="w-full rounded-2xl border border-white/15 bg-slate-900/60 px-3 py-2.5 text-sm text-slate-50 placeholder:text-slate-500 focus:ring-2 focus:ring-indigo-400 focus:border-transparent outline-none"
              placeholder="Descreva o passo a passo do problema, mensagens de erro, hor√°rio aproximado em que ocorreu, impacto no atendimento, etc."
            ></textarea>
          </div>

          <!-- Mensagem -->
          <p id="formMsg" class="text-xs mt-1"></p>

          <!-- A√á√ïES -->
          <div class="flex flex-col sm:flex-row gap-3 pt-2">
            <button
              type="submit"
              id="btnSubmitChamado"
              class="inline-flex justify-center items-center gap-2 rounded-2xl bg-indigo-500 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-400 shadow shadow-indigo-500/40 transition disabled:opacity-60 disabled:cursor-not-allowed"
            >
              üöÄ Enviar chamado
            </button>

            <a
              href="chamados.html"
              class="inline-flex justify-center items-center rounded-2xl border border-white/10 px-4 py-2.5 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
            >
              Ver meus chamados
            </a>
          </div>
        </form>
      </section>

      <!-- LATERAL: RESUMO & DICAS -->
      <aside class="space-y-4">
        <section class="bg-white/5 border border-white/10 rounded-3xl shadow-xl shadow-black/40 backdrop-blur p-5 space-y-3">
          <h2 class="text-sm font-semibold text-slate-50">Resumo do registro</h2>
          <p class="text-xs text-slate-300">
            O chamado ser√° salvo localmente no seu navegador e listado na tela
            <span class="font-semibold text-slate-100">Meus Chamados</span>. Em produ√ß√£o, ele seria enviado √† API da HelpTech.
          </p>
          <ul class="text-xs text-slate-300 space-y-1.5">
            <li>‚Ä¢ Status inicial: <span class="font-semibold text-slate-100">Em aberto</span>.</li>
            <li>‚Ä¢ Data e hora s√£o registradas automaticamente.</li>
            <li>‚Ä¢ Seu e-mail √© associado ao chamado.</li>
          </ul>
        </section>

        <section class="bg-slate-900/70 border border-indigo-400/30 rounded-3xl shadow-xl shadow-black/40 backdrop-blur p-5 space-y-3">
          <h2 class="text-sm font-semibold text-indigo-100">Dica para descri√ß√£o</h2>
          <p class="text-xs text-slate-200">
            Sempre que poss√≠vel, inclua:
          </p>
          <ul class="text-xs text-slate-200 space-y-1.5 list-disc list-inside">
            <li>O que voc√™ estava fazendo quando o erro aconteceu;</li>
            <li>Print ou texto da mensagem de erro;</li>
            <li>Se outras pessoas tamb√©m foram afetadas;</li>
            <li>Qual sistema, ag√™ncia ou ambiente foi impactado.</li>
          </ul>
        </section>
      </aside>
    </div>
  </main>

  <script>
    // ===== SESS√ÉO / PERFIL =====
    function getSessionUser() {
      try {
        return JSON.parse(localStorage.getItem('sessionUser') || 'null');
      } catch {
        return null;
      }
    }

    function initials(nome) {
      return (nome || '')
        .split(' ')
        .filter(Boolean)
        .slice(0, 2)
        .map(s => s[0].toUpperCase())
        .join('') || '??';
    }

    const sess = getSessionUser();
    if (!sess) {
      window.location.href = 'index.html';
    } else if (sess.perfil === 'admin') {
      // Admin n√£o abre chamado ‚Üí vai direto para o dashboard
      window.location.href = 'admin.html';
    }

    const btnProfileCircle = document.getElementById('btnProfileCircle');
    btnProfileCircle.textContent = initials(sess?.nome);

    function doLogout() {
      localStorage.removeItem('sessionUser');
      window.location.href = 'index.html';
    }
    document.getElementById('logoutTop').addEventListener('click', doLogout);

    // ===== CHAMADOS (LOCALSTORAGE) =====
    function loadChamados() {
      try {
        return JSON.parse(localStorage.getItem('chamados') || '[]');
      } catch {
        return [];
      }
    }

    function saveChamados(lista) {
      localStorage.setItem('chamados', JSON.stringify(lista));
    }

    function setFormMsg(text, type) {
      const el = document.getElementById('formMsg');
      el.textContent = text || '';
      el.className = 'text-xs mt-1';
      if (type === 'error') el.classList.add('text-red-400');
      if (type === 'success') el.classList.add('text-green-400');
      if (type === 'info') el.classList.add('text-slate-300');
    }

    function gerarIdChamado(lista) {
      const prefix = 'CH-';
      const maxSeq = lista
        .map(c => c.id)
        .filter(id => typeof id === 'string' && id.startsWith(prefix))
        .map(id => parseInt(id.replace(prefix, ''), 10))
        .filter(n => !Number.isNaN(n))
        .reduce((max, n) => Math.max(max, n), 0);

      const next = maxSeq + 1;
      return prefix + String(next).padStart(4, '0');
    }

    // ===== FORM NOVO CHAMADO =====
    const formChamado = document.getElementById('formChamado');
    const btnSubmitChamado = document.getElementById('btnSubmitChamado');

    formChamado.addEventListener('submit', (e) => {
      e.preventDefault();
      setFormMsg('', null);

      const categoria = document.getElementById('categoria').value.trim();
      const prioridade = document.getElementById('prioridade').value.trim();
      const titulo = document.getElementById('titulo').value.trim();
      const descricao = document.getElementById('descricao').value.trim();

      if (!categoria || !prioridade || !descricao) {
        setFormMsg('Preencha todos os campos obrigat√≥rios.', 'error');
        return;
      }

      btnSubmitChamado.disabled = true;

      const lista = loadChamados();
      const id = gerarIdChamado(lista);
      const agora = new Date().toISOString();

      const novoChamado = {
        id,
        categoria,
        prioridade,
        titulo,
        descricao,
        criadoEm: agora,
        status: 'Em aberto',
        usuarioEmail: sess?.email || null,
        usuarioNome: sess?.nome || null,
        usuarioPerfil: sess?.perfil || 'usuario'
      };

      lista.push(novoChamado);
      saveChamados(lista);

      setFormMsg('Chamado criado com sucesso! Redirecionando para Meus Chamados...', 'success');
      formChamado.reset();

      setTimeout(() => {
        window.location.href = 'chamados.html';
      }, 700);
    });
  </script>
</body>
</html>
